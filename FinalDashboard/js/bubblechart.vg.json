{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 290,
  "height": 200,
  "padding": 20,
  "title": {
    "text": "Number of Hawker Stalls by Category",
    "anchor": "middle",
    "dy": -10
  },
  
  "signals": [
    {
      "name": "clear",
      "value": true,
      "on": [
        {
          "events": "mouseup[!event.item]",
          "update": "true",
          "force": true
        }
      ]
    },
    {
      "name": "shift",
      "value": false,
      "on": [
        {
          "events": "@legendSymbol:click, @legendLabel:click",
          "update": "event.shiftKey",
          "force": true
        }
      ]
    },
    {
      "name": "clicked",
      "value": null,
      "on": [
        {
          "events": "@legendSymbol:click, @legendLabel:click",
          "update": "{value: datum.value}",
          "force": true
        }
      ]
    }
  ],
  
  "data": [
    {
      "name": "selected",
      "on": [
        {"trigger": "clear", "remove": true},
        {"trigger": "!shift", "remove": true},
        {"trigger": "!shift && clicked", "insert": "clicked"},
        {"trigger": "shift && clicked", "toggle": "clicked"}
      ]
    },
    {
      "name": "stalls",
      "values": [
        {"category": "Metal", "count": 8826, "x": 205, "y": 240},
        {"category": "Large stall", "count": 5984, "x": 83, "y": 180},
        {"category": "One piece", "count": 5839, "x": 325, "y": 175},
        {"category": "Table", "count": 3620, "x": 120, "y": 345},
        {"category": "Food truck", "count": 678, "x": 265, "y": 340}
      ]
    }
  ],
  
  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "domain": {"data": "stalls", "field": "category"},
      "range": ["#d1c4e9", "#ffcc80", "#add8e6", "#b2df8a", "#b39978"]
    },
    {
      "name": "size",
      "type": "sqrt",
      "domain": [0, 9000],
      "range": [4000, 20000]  
    }
  ],
  
  "legends": [
    {
      "fill": "color",
      "title": "Stall Category",
      "orient": "right",
      "encode": {
        "symbols": {
          "name": "legendSymbol",
          "interactive": true,
          "update": {
            "fill": {"scale": "color", "field": "value"},
            "stroke": {"value": "white"},
            "strokeWidth": {"value": 0},
            "opacity": [
              {
                "test": "!length(data('selected')) || indata('selected', 'value', datum.value)",
                "value": 0.7
              },
              {"value": 0.15}
            ],
            "size": {"value": 64}
          }
        },
        "labels": {
          "name": "legendLabel",
          "interactive": true,
          "update": {
            "fill": {"value": "black"},
            "opacity": [
              {
                "test": "!length(data('selected')) || indata('selected', 'value', datum.value)",
                "value": 1
              },
              {"value": 0.25}
            ]
          },
          "hover": {
            "fill": {"value": "firebrick"}
          }
        }
      }
    }
  ],
  
  "marks": [
    {
      "type": "symbol",
      "from": {"data": "stalls"},
      "encode": {
        "enter": {
          "x": {"field": "x"},
          "y": {"field": "y"},
          "size": {"scale": "size", "field": "count"},
          "fill": {"scale": "color", "field": "category"},
          "stroke": {"value": "white"},
          "strokeWidth": {"value": 0}
        },
        "update": {
          "opacity": [
            {
              "test": "!length(data('selected')) || indata('selected', 'value', datum.category)",
              "value": 1
            },
            {"value": 0.2}
          ],
          "fillOpacity": [
            {
              "test": "!length(data('selected')) || indata('selected', 'value', datum.category)",
              "value": 0.8
            },
            {"value": 0.2}
          ],
          "strokeOpacity": [
            {
              "test": "!length(data('selected')) || indata('selected', 'value', datum.category)",
              "value": 1
            },
            {"value": 0.2}
          ],
          "tooltip": {
            "signal": "{'Category': datum.category, 'Number of Stalls': format(datum.count, ',')}"
          }
        }
      }
    },
    {
      "type": "text",
      "from": {"data": "stalls"},
      "encode": {
        "update": {
          "x": {"field": "x"},
          "y": {"field": "y", "offset": -8},
          "text": {"field": "category"},
          "align": {"value": "center"},
          "baseline": {"value": "middle"},
          "fill": {"value": "black"},
          "fontSize": {"value": 14},  
          "fontWeight": {"value": "bold"},
          "opacity": [
            {
              "test": "!length(data('selected')) || indata('selected', 'value', datum.category)",
              "value": 1
            },
            {"value": 0.2}
          ]
        }
      }
    },
    {
      "type": "text",
      "from": {"data": "stalls"},
      "encode": {
        "update": {
          "x": {"field": "x"},
          "y": {"field": "y", "offset": 8},
          "text": {"signal": "format(datum.count, ',')"},
          "align": {"value": "center"},
          "baseline": {"value": "middle"},
          "fill": {"value": "#333"},
          "fontSize": {"value": 13},
          "opacity": [
            {
              "test": "!length(data('selected')) || indata('selected', 'value', datum.category)",
              "value": 1
            },
            {"value": 0.2}
          ]
        }
      }
    },
    {
      "type": "text",
      "name": "filter_instruction",
      "encode": {
        "update": {
          "x": {"value": 345},
          "y": {"value": 79},
          "text": {"value": "â†‘ Click To Filter"},
          "align": {"value": "center"},
          "baseline": {"value": "top"},
          "fontSize": {"value": 11},
          "fill": {"value": "#7B3F00"}
        }
      }
    }
  ]
}